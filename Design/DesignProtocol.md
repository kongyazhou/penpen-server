# protocol-design

```
本文档将介绍penpen使用的通信协议以及通信的流程。

当前协议版本号：PENPEN 1.0
```

## 概述

penpen是一个企业级IM应用，是一个为企业客户提供文本、语音、视频聊天，及会议场所的移动平台。

使用penpen，所有消息都会在服务器端备份，随时能够查询，永不丢失。

## 通信协议设计

```
本通信协议设计以实现功能为主要目标。
暂不考虑复杂的加密和可靠性设计。
```

#### PENPEN端口与服务映射关系

1100~1199为PENPEN使用的服务器端口号，不同端口对应不同服务

面向websocket通信

```
20888	登录	，读取消息(服务号1)	
21888	发送消息		
22888	发送图片(未使用)
23888	发送语音(未做)
25888	发送广播(未做)
26888	发送群消息	
	
30888	注册账号
31888	更新签名
32888	更新密码(未做)
33888	更新活跃状态

30666	注册账号验证码
32666	修改密码验证码

50888	同步所有消息	
51888	同步所有联系人
52888	同步签名(指定联系人)(未做)
53888	同步所有讨论组
55888	同步广播(未做)

60888	创建讨论组
61888	修改讨论组信息(未做)
62888	修改成员(未做)

```

**PENPEN编码号**

1100	未加密

1110	base64

1160	md5加密		32位小写

更多编码方式参考下面的资料：

```
该服务以非常长的格式加密字符串。可在下列其中一项之间进行加密： ASCII、二进制、十六进制、反向、BASE64、DES、l33t、MD5、ROT-13、Url 编码字符串、UU 编码字符串。 每个加密类型都可以视为一个单独的方法，确保所需功能的正确输出。 在有些情况下（如适用），该工具可提供加密-解密方法。在其他地方（例如使用 MD5 和 DES 时） 加密方法只适用于单向。

单向：3个著名加密算法(MD5、RSA、DES)
```

## 编码方式

由于服务器端中文适应性差，故凡是会用到中文的地方先进行一次base64编码。

有以下几个地方：用户信息表：姓名、个性签名
消息的内容
上传的文件名
广播内容


#### 通信包格式

```json
{
	"head":1110,//编码代号
	"body":"asasfaf",//base64加密
	"tail":"PENPEN 1.0"//PENPEN协议版本号
}
```

#### Message格式


**消息包**c2s

发送:(接收时比发送多一个time字段)

```json
{
	"from":"15228977313",
	"to":"1231241243",//对方账号，或群号
	"type":0,//0:文字，1:图片，2:语音，10：群文字，11：群图片，12：群语音，19：创建讨论组通知
	"content":"约吗"//base64
}
```

服务器收到后加上一个"time"字段后，将消息存入"to"所属的数据库中未读表中，并向syncDeamon发送SIGNAL

syncDeamon收到SIGNAL后，从未读数据库中取出数据，加密组包后，向客户端同步

**图片消息**

发送者发送图片消息，消息内容为图片名，并上传图片；然后再下载图片，下载成功后添加本地消息

接收者收到图片消息后，下载图片；完成后添加本地消息

图片消息存储

文件名:接收方id + $scope.contact.user + picnumber + ".jpg"

**登陆包**c2s

```json
{
	"user":"12345678900",
	"password":"密码;md5"
}
```

按下按钮后连接服务器(可否提前至打开app时？)，并发送登陆包，服务器收到包后，核对用户名密码，成功后更新在线状态表，保持与服务器的连接。

[站长之家在线加密](http://tool.chinaz.com/tools/md5.aspx)

**登录状态返回包**s2c

*TODO:
state改为status
增加账号字段*

```json
{
	"state":"登陆状态;int;11:登录成功,12:登录失败"
}
```

**更新签名包**c2s

```json
{
	"user":"账号;str;12345678900",
	"signing":"签名;base64;今天天气好好~"
}
```

**同步联系人包**s2c

```json
{
	"departments":"{
				1:"GBGYU&TG",(base64)
				2:"G^&UBF^T&U",(base64)
				...
	}", 
	"jobs":"{
				1:"F%&",(base64)
				2:"GHIHGF&",(base64)
				...
	}", 
	"contacts":"[{
		"name": "Ardfs",(base64)
 		"user": "12345678900",
 		"department": "3",(编号)
 		"job": "2",(编号)
 		"signing": "sthEF"(base64)
		},{
			...
		},
		...
	]"
}
```

**同步讨论组包**s2c

```json
{
	"groups":"所有讨论组;str;[{},{}...]"
}
```

**创建讨论组包**c2s

```json
{
	"holder":"创建者ID;str;12345678903",
	"name":"讨论组名;base64;ASD13r4",
	"member":"所有成员账号(包括创建者);str;12345678900,12345678909,12345678903"
}
```

**讨论组创建通知包**s2c

```json
{
	"from": "0",
    "to": "gid",
    "type": 19,
    "content": {
        "holder": self.group["holder"],
        "name": self.group["name"],
        "member": self.group["member"]
	}(base64)

}
```

**同步所有消息请求包**c2s

```json
{
	"user":"请求者ID;str;123",
	"target":"目标ID;str;12345678909"
}
```

**同步所有消息返回包**s2c

```json
{
	"messages":"所有消息;str;[{"from":"%s","to":"%s","time":"%s","type":%d,"content":"%s"},
		{}, ... ,{}]"
}
```

**注册包**c2s

```json
{
	"user":"账号;str;手机号",
	"name":"姓名;base64",
	"password":"密码;md5",
	"captcha":"验证码;int",
	"time":"注册时间;str;y-m-d h-m-s"
}
```

**注册状态返回包**s2c

```json
{
	"user":"账号;str;手机号",
	"status":"注册状态;int;0:成功,1:账号已存在,2:验证码错误,3:验证码超时",
	"time":"注册时间;str;y-m-d h-m-s"
}
```

**注册账号验证码**c2s

```json
{
	"user":"注册账号;str;手机号",
	"time":"时间;str;y-m-d h-m-s"
}
```

**注册账号验证码返回包**c2s

```json
{
	"user":"注册账号;str;手机号",
	"status":"验证码状态;int;0:成功,1:失败",
	"time":"时间;str;y-m-d h-m-s"
}
```
