# penpen-protocol

```
本文档将介绍penpen使用的通信流程，以及通信协议。

当前协议版本号：PENPEN 1.0
```

## 概述

penpen是一个企业级IM应用

主要为企业客户提供文本、语音、视频聊天，及会议的移动平台。

使用本平台，可使所有消息在服务器端备份，随时查询，永不丢失。

## 系统介绍

penpen由移动客户端和服务器端组成。


## 通信协议设计

参考[ionic-wechat](https://github.com/Frogmarch/ionic-wechat)中的协议。



#### PENPEN端口与服务映射关系**

1100~1199为PENPEN使用的服务器端口号，不同端口对应不同服务

面向websocket通信

20888	登录			userLogin
21888	发送消息		sendMessage
22888	发送广播		sendBroadcast
23888	更新签名
24888	上传图片
25888	更新头像
26888	更新密码
27888	同步联系人[该消息由于不需要发送内容，仅需下载，故单独定义端口号访问，每次]
28888	同步消息
29888	同步广播


**PENPEN编码号**

1100	未加密

1110	base64

1160	md5加密

更多编码方式参考下面的资料：

```
该服务以非常长的格式加密字符串。可在下列其中一项之间进行加密： ASCII、二进制、十六进制、反向、BASE64、DES、l33t、MD5、ROT-13、Url 编码字符串、UU 编码字符串。 每个加密类型都可以视为一个单独的方法，确保所需功能的正确输出。 在有些情况下（如适用），该工具可提供加密-解密方法。在其他地方（例如使用 MD5 和 DES 时） 加密方法只适用于单向。

单向：3个著名加密算法(MD5、RSA、DES)
```

## 编码方式

由于服务器端中文适应性差，故凡是会用到中文的地方先进行一次base64编码。

有以下几个地方：用户信息表：姓名、个性签名
消息的内容
上传的文件名
广播内容


#### 通信包格式

客户端至服务器：

```json
{
	"head":编码号,
	"body":json消息(base64加密),
	"tail":PENPEN协议版本号
}
```

#### Message格式**

- **客户端至服务器**

**消息包**

发送:(接收时比发送多一个time字段)

```json
{
	"from":"15228977313",
	"to":"1231241243",
	"type":0,(0:文字，1:图片，2:语音)
	"content":"约吗"(base64)
}
```

服务器收到后加上一个"TIME"字段存入"TO"所属的数据库中未读表中，并向syncDeamon发送SIGNAL

syncDeamon收到SIGNAL后，从未读数据库中取出数据，加密组包后，向客户端同步

**登陆包**

```json
{
	"user":"15669910222",
	"password":"11"(32位md5小写)
}
```

按下按钮后连接服务器(可否提前至打开app时？)，并发送登陆包，服务器收到包后，核对用户名密码，成功后更新在线状态表，保持与服务器的连接。

[站长之家在线加密](http://tool.chinaz.com/tools/md5.aspx)

- **服务器至客户端**

**登录状态返回包**

```
{
	"state":11,(11:登录成功,12:密码错误,13:不存在用户,14:长期未登录)
}
```








